function modernizerFunction(e,o){if(log.info("Entering  modernizerFunction"),e.draganddrop){var t=o.querySelectorAll("#images img");[].forEach.call(t,function(e){e.addEventListener("dragstart",handleDragStart,!1),e.addEventListener("dragend",handleDragEnd,!1)});var n=o.getElementById("canvas-container");n.addEventListener("dragenter",handleDragEnter,!1),n.addEventListener("dragover",handleDragOver,!1),n.addEventListener("dragleave",handleDragLeave,!1),n.addEventListener("drop",handleDrop,!1)}else alert("This browser doesn't support the HTML5 Drag and Drop API.");log.info("Leaving  modernizerFunction")}function debounce(e,o,t){var n;return function(){var r=this,a=arguments,c=function(){n=null,t||e.apply(r,a)},i=t&&!n;clearTimeout(n),n=setTimeout(c,o),i&&e.apply(r,a)}}function GetDebugParameter(e){log.info("Entering  GetDebugParameter");var o=window.location.hash;if(log.debug("sPageURL:"),log.debug(o),o=o.split("?"),!(o.length>1))return log.info("Leaving GetDebugParameter returning false"),!1;var t=o[1].split("&");log.debug("sURLVariables:"),log.debug(t);for(var n=0;n<t.length;n++){var r=t[n].split("=");if(log.debug("sParameterName:"),log.debug(r),r[0]==e)return log.debug("sParameterName[1]:"),log.debug(r[1]),log.info("Leaving GetDebugParameter"),r[1]}}function setLinePositions(e){var o=e.target,t=o.get("type");if("customline"==t){var n=o.get("objId"),r=_curX-e.e.clientX,a=_curY-e.e.clientY;console.log("_curX, _curY: ",_curX," ",_curY),console.log("Deltas: ",r," ",a);for(var c=0;c<canvas.getObjects().length;c++){var i=canvas.getObjects()[c];"circleone"==i.type&&i.get("belongsTo")==n&&(_c2Top=i.getTop(),_c2Left=i.getLeft(),console.log("In circleone",i),console.log("currentObj.left: ",i.left),console.log("currentObj.top: ",i.top),console.log("New currentObj.left: ",i.left-r),console.log("New currentObj.top: ",i.top-a),i.set({left:i.left-r,top:i.top-a}),i.setCoords(),i.line&&i.line.set({x2:i.left,y2:i.top}),i.line.setCoords()),"circlezero"==i.type&&i.get("belongsTo")==n&&(_c1Top=i.getTop(),_c1Left=i.getLeft(),i.set({left:i.left-r,top:i.top-a}),i.setCoords(),i.line&&i.line.set({x1:i.left,y1:i.top}),i.line.setCoords())}_curX=e.e.clientX,_curY=e.e.clientY}if("customlinearrow"==t){console.log("In customlinearrow");var n=o.get("objId"),r=_curX-e.e.clientX,a=_curY-e.e.clientY;console.log("Deltas: ",r," ",a);for(var c=0;c<canvas.getObjects().length;c++){var i=canvas.getObjects()[c];console.log("currentObj: ",i),"carrow"==i.type&&i.get("belongsTo")==n&&(console.log("In carrow",i),console.log("currentObj.left: ",i.left),console.log("currentObj.top: ",i.top),console.log("New currentObj.left: ",i.left-r),console.log("New currentObj.top: ",i.top-a),_c2Top=i.getTop(),_c2Left=i.getLeft(),i.set({left:i.left-r,top:i.top-a}),i.setCoords(),i.line&&i.line.set({x2:i.left,y2:i.top}),i.line.setCoords()),"conearrow"==i.type&&i.get("belongsTo")==n&&(console.log("In conearrow",i),_c1Top=i.getTop(),_c1Left=i.getLeft(),console.log("New currentObj.left: ",i.left-r),console.log("New currentObj.top: ",i.top-a),i.set({left:i.left-r,top:i.top-a}),i.setCoords(),i.line&&i.line.set({x1:i.left,y1:i.top}),i.line.setCoords())}_curX=e.e.clientX,_curY=e.e.clientY}if("customlinetwoarrow"==t){console.log("In customlinetwoarrow");var n=o.get("objId"),r=_curX-e.e.clientX,a=_curY-e.e.clientY;console.log("Deltas: ",r," ",a);for(var c=0;c<canvas.getObjects().length;c++){var i=canvas.getObjects()[c];console.log("currentObj: ",i),"carrowtwo"==i.type&&i.get("belongsTo")==n&&(console.log("In carrowtwo",i),console.log("currentObj.left: ",i.left),console.log("currentObj.top: ",i.top),console.log("New currentObj.left: ",i.left-r),console.log("New currentObj.top: ",i.top-a),_c2Top=i.getTop(),_c2Left=i.getLeft(),i.set({left:i.left-r,top:i.top-a}),i.setCoords(),i.line&&i.line.set({x1:i.left,y1:i.top}),i.line.setCoords()),"carrow"==i.type&&i.get("belongsTo")==n&&(console.log("In conearrow",i),_c1Top=i.getTop(),_c1Left=i.getLeft(),console.log("New currentObj.left: ",i.left-r),console.log("New currentObj.top: ",i.top-a),i.set({left:i.left-r,top:i.top-a}),i.setCoords(),i.line&&i.line.set({x2:i.left,y2:i.top}),i.line.setCoords())}_curX=e.e.clientX,_curY=e.e.clientY}}function setLineCirclePositionsBoundary(e){var o=e.target;o.get("type"),o.get("objId"),_curX-e.e.clientX,_curY-e.e.clientY;"customline"==o.type&&(_circleOne=o.cone,_circleTwo=o.ctwo,_circleTwo&&_circleTwo.set({left:_c2Left,top:_c2Top}),_circleTwo.setCoords(),_circleTwo.line&&_circleTwo.line.set({x2:_circleTwo.left,y2:_circleTwo.top}),_circleTwo.line.setCoords(),_circleOne&&_circleOne.set({left:_c1Left,top:_c1Top}),_circleOne.setCoords(),_circleOne.line&&_circleOne.line.set({x1:_circleOne.left,y1:_circleOne.top}),_circleOne.line.setCoords(),o&&o.set({x1:_circleOne.left,y1:_circleOne.top,x2:_circleTwo.left,y2:_circleTwo.top})),"customlinearrow"==o.type&&(_circleOne=o.conearrow,_circleTwo=o.carrow,_circleTwo&&_circleTwo.set({left:_c2Left,top:_c2Top}),_circleTwo.setCoords(),_circleTwo.line&&_circleTwo.line.set({x2:_circleTwo.left,y2:_circleTwo.top}),_circleTwo.line.setCoords(),_circleOne&&_circleOne.set({left:_c1Left,top:_c1Top}),_circleOne.setCoords(),_circleOne.line&&_circleOne.line.set({x1:_circleOne.left,y1:_circleOne.top}),_circleOne.line.setCoords(),o&&o.set({x1:_circleOne.left,y1:_circleOne.top,x2:_circleTwo.left,y2:_circleTwo.top})),"customlinetwoarrow"==o.type&&(_circleOne=o.carrow,_circleTwo=o.carrowtwo,_circleTwo&&_circleTwo.set({left:_c2Left,top:_c2Top}),_circleTwo.setCoords(),_circleTwo.line&&_circleTwo.line.set({x2:_circleTwo.left,y2:_circleTwo.top}),_circleTwo.line.setCoords(),_circleOne.line&&_circleOne.set({left:_c1Left,top:_c1Top}),_circleOne.setCoords(),_circleOne.line&&_circleOne.line.set({x1:_circleOne.left,y1:_circleOne.top}),_circleOne.line.setCoords(),o&&o.set({x1:_circleOne.left,y1:_circleOne.top,x2:_circleTwo.left,y2:_circleTwo.top})),o.setCoords(),_curX=e.e.clientX,_curY=e.e.clientY}function objectBoundaryCheck(e){var o=!1;if(setLinePositions(e),log.info("Entering  objectBoundaryCheck"),$("#saveMessage").text("Changes Made, Save Pending..."),e.target.setCoords(),console.log("Object in boundary check: ",e.target),log.debug("Checking to see if the end points of a line are being dragged "),"circlezero"!=e.target.type&&"circleone"!=e.target.type&&"conearrow"!=e.target.type&&"carrow"!=e.target.type&&"carrowtwo"!=e.target.type){var t=e.target,n=e.target.getBoundingRect().top+e.target.getBoundingRect().height,r=e.target.getBoundingRect().left+e.target.getBoundingRect().width,a=t.getBoundingRect(),c=-(a.left-t.left),i=-(a.top-t.top);bounds={tl:{x:0,y:0},br:{x:canvas.width,y:canvas.height}},log.debug("Checking to see if we hit the top-left corner"),(e.target.getBoundingRect().top<=bounds.tl.y||e.target.getBoundingRect().left<=bounds.tl.x)&&(log.debug("hit the top-left corner"),e.target.setTop(Math.max(e.target.top,i)),e.target.left=Math.max(e.target.left,c),"customline"!=e.target.type&&"customlinearrow"!=e.target.type&&"customlinetwoarrow"!=e.target.type||(setLineCirclePositionsBoundary(e),canvas.deactivateAll()),o=!0,e.target.setCoords()),log.debug("Checking to see if we hit the bot-right corner"),(n>=bounds.br.y||r>=bounds.br.x)&&(n>=bounds.br.y&&(e.target.angle>=270&&e.target.angle<360?e.target.top=bounds.br.y-e.target.getBoundingRect().height+i:e.target.angle>=90&&e.target.angle<=180?(e.target.top=bounds.br.y-e.target.getBoundingRect().height+i,log.debug("Calculated Top: "+(bounds.br.y-e.target.getBoundingRect().height+i))):e.target.angle>180&&e.target.angle<270?e.target.top=bounds.br.y-e.target.getBoundingRect().height+i:e.target.angle>=0&&e.target.angle<90&&(e.target.top=bounds.br.y-e.target.getBoundingRect().height+i)),r>=bounds.br.x&&(e.target.angle>=270&&e.target.angle<360?e.target.left=bounds.br.x-e.target.getBoundingRect().width:e.target.angle>=90&&e.target.angle<=180?e.target.left=bounds.br.x:e.target.angle>180&&e.target.angle<270?e.target.left=bounds.br.x-e.target.getBoundingRect().width+c:e.target.angle>=0&&e.target.angle<90&&(e.target.left=bounds.br.x-e.target.getBoundingRect().width+c)),o=!0,"customline"!=e.target.type&&"customlinearrow"!=e.target.type&&"customlinetwoarrow"!=e.target.type||(setLineCirclePositionsBoundary(e),canvas.deactivateAll()),e.target.setCoords())}else boundaryInspectorCircle(e);onSave(),log.info("Leaving objectBoundaryCheck")}function textChangedEvent(e){$("#saveMessage").text("Changes Made, Save Pending..."),log.debug("text:changed",e.target,e),onSave()}function objectDeletedEvent(e){$("#saveMessage").text("Changes Made, Save Pending..."),log.debug("lineDeletedEvent",e.target,e),onSave()}function boundaryInspectorCircle(e){log.info("Entering boundaryInspectorCircle"),e.target.setCoords();var o=e.target;console.log("Type is: ",o.type),bounds={tl:{x:0,y:0},br:{x:canvas.width,y:canvas.height}},"circleone"!=o.type&&"circlezero"!=o.type||(o.top<bounds.tl.y||o.left<bounds.tl.x?(e.target.setTop(Math.max("0",e.target.top)),e.target.left=Math.max("0",e.target.left)):(o.top+2*o.radius>bounds.br.y||o.left+2*o.radius>bounds.br.x)&&(e.target.setTop(Math.min(bounds.br.y,e.target.top+2*o.radius)),e.target.left=Math.min(bounds.br.x,e.target.left+2*o.radius)),"circleone"==o.type?o.line&&o.line.set({x1:o.line.cone.left,y1:o.line.cone.top,x2:o.line.ctwo.left,y2:o.line.ctwo.top}):o.line&&o.line.set({x1:o.line.cone.left,y1:o.line.cone.top,x2:o.line.ctwo.left,y2:o.line.ctwo.top}),o.line.setCoords(),e.target.setCoords()),"conearrow"==o.type&&(o.top<bounds.tl.y||o.left<bounds.tl.x?(e.target.setTop(Math.max("0",e.target.top)),e.target.left=Math.max("0",e.target.left)):(o.top+2*o.radius>bounds.br.y||o.left+2*o.radius>bounds.br.x)&&(e.target.setTop(Math.min(bounds.br.y,e.target.top+2*o.radius)),e.target.left=Math.min(bounds.br.x,e.target.left+2*o.radius)),console.log("conearrow: ",o.line),o.line&&o.line.set({x1:o.line.conearrow.left,y1:o.line.conearrow.top,x2:o.line.carrow.left,y2:o.line.carrow.top}),o.line.setCoords(),angle=calcArrowAngle(o.line.x1,o.line.y1,o.line.x2,o.line.y2),o.line.carrow.set("angle",angle+90),e.target.setCoords()),"carrow"==o.type&&(o.top<bounds.tl.y||o.left<bounds.tl.x?(e.target.setTop(Math.max("0",e.target.top)),e.target.left=Math.max("0",e.target.left)):(o.top>bounds.br.y||o.left+o.width>bounds.br.x)&&(e.target.setTop(Math.min(bounds.br.y,e.target.top)),e.target.left=Math.min(bounds.br.x,e.target.left+o.width)),console.log("carrow: ",o),console.log("line: ",o.line),"customlinetwoarrow"==o.line.type?o.line&&o.line.set({x1:o.line.carrowtwo.left,y1:o.line.carrowtwo.top,x2:o.line.carrow.left,y2:o.line.carrow.top}):o.line&&o.line.set({x1:o.line.conearrow.left,y1:o.line.conearrow.top,x2:o.line.carrow.left,y2:o.line.carrow.top}),o.line.setCoords(),angle=calcArrowAngle(o.line.x1,o.line.y1,o.line.x2,o.line.y2),o.set("angle",angle+90),"customlinetwoarrow"==o.line.type&&o.line.carrowtwo.set({angle:angle-90}),e.target.setCoords()),"carrowtwo"==o.type&&(o.top<bounds.tl.y||o.left<bounds.tl.x?(e.target.setTop(Math.max("0",e.target.top)),e.target.left=Math.max("0",e.target.left)):(o.top>bounds.br.y||o.left+o.width>bounds.br.x)&&(e.target.setTop(Math.min(bounds.br.y,e.target.top)),e.target.left=Math.min(bounds.br.x,e.target.left+o.width)),console.log("carrowtwo: ",o.line),o.line&&o.line.set({x1:o.left,y1:o.top,x2:o.line.carrow.left,y2:o.line.carrow.top}),o.line.setCoords(),angle=calcArrowAngle(o.line.x1,o.line.y1,o.line.x2,o.line.y2),o.set("angle",angle-90),o.line.carrow.set("angle",angle+90),e.target.setCoords()),log.info("Leaving boundaryInspectorCircle")}function objectResize(e){log.info("Entering objectResize"),"circle"==e.target.type?(newWidth=e.target.width*e.target.scaleX,newRadius=e.target.radius*e.target.scaleX,e.target.set({width:newWidth,radius:newRadius,height:newWidth,scaleX:1,scaleY:1})):"ellipse"==e.target.type?(newWidth=e.target.width*e.target.scaleX,newHeight=e.target.height*e.target.scaleY,newRadiusX=newWidth/2,newRadiusY=newHeight/2,e.target.set({rx:newRadiusX,ry:newRadiusY,scaleX:1,scaleY:1})):"rect"==e.target.type&&(newWidth=e.target.width*e.target.scaleX,newHeight=e.target.height*e.target.scaleY,e.target.set({height:newHeight,width:newWidth,scaleX:1,scaleY:1})),objectBoundaryCheck(e),log.info("Leaving objectResize")}function selectionCleared(){log.info("Entering selectionCleared"),lineActive=!0,lineSelected=!1,log.debug("lineActive: ",lineActive),log.debug("lineSelected: ",lineSelected),log.info("Leaving selectionCleared")}function mouseDown(e){log.info("Entering mouseDown"),e.preventDefault&&e.preventDefault(),$("#contextMenu").remove(),contextmenuon=!1,activeObject=!1,log.debug("contextmenuon: ",contextmenuon),log.info("Leaving mouseDown")}function objectSelected(e){log.info("Entering objectSelected"),activeObject=!0,activeObjectVal=e.target,console.log("objectSelected: ",activeObjectVal);var o=e.target.get("type");"customline"==o&&(console.log("custom line selected"),_curX=e.e.clientX,_curY=e.e.clientY,_c1Top=e.target.cone.getTop(),_c1Left=e.target.cone.getLeft(),_c2Top=e.target.ctwo.getTop(),_c2Left=e.target.ctwo.getLeft()),"customlinearrow"==o&&(console.log("custom line selected"),_curX=e.e.clientX,_curY=e.e.clientY,_c1Top=e.target.conearrow.getTop(),_c1Left=e.target.conearrow.getLeft(),_c2Top=e.target.carrow.getTop(),_c2Left=e.target.carrow.getLeft()),"customlinetwoarrow"==o&&(console.log("custom line two selected"),_curX=e.e.clientX,_curY=e.e.clientY,_c1Top=e.target.carrow.getTop(),_c1Left=e.target.carrow.getLeft(),console.log("customlinetwoarrow: ",e.target),_c2Top=e.target.carrowtwo.get("top"),_c2Left=e.target.carrowtwo.getLeft());var t=canvas.getActiveGroup(),n=new Array,r=new Array,a=new Array;if(t){for(groupObjectsCircleOne=t.getObjects("circleone"),i=0;i<groupObjectsCircleOne.length;i++)r.push(groupObjectsCircleOne[i].belongsTo);for(groupObjectsCircleZero=t.getObjects("circlezero"),i=0;i<groupObjectsCircleZero.length;i++)n.push(groupObjectsCircleZero[i].belongsTo);for(groupObjectsCustomLine=t.getObjects("customline"),i=0;i<groupObjectsCustomLine.length;i++)a.push(groupObjectsCustomLine[i].objId);for(console.log("circleOneInCollection:",r),console.log("circleZeroInCollection:",n),console.log("customLineInCollection:",a),allObjects=canvas.getObjects(),i=0;i<n.length;i++){if(-1==$.inArray(n[i],r))for(j=0,notFound=!0;j<allObjects.length&&notFound;)"circleone"==allObjects[j].type&&allObjects[j].belongsTo==n[i]&&(r.push(n[i]),t.addWithUpdate(allObjects[j]),console.log("Found circleone for circlezero",r),notFound=!1),j+=1;if(-1==$.inArray(n[i],a))for(j=0,notFound=!0;j<allObjects.length&&notFound;)"customline"==allObjects[j].type&&allObjects[j].objId==n[i]&&(a.push(n[i]),t.addWithUpdate(allObjects[j]),notFound=!1,console.log("Found customline for circlezero",a)),j+=1}for(i=0;i<r.length;i++){if(-1==$.inArray(r[i],n))for(j=0,notFound=!0;j<allObjects.length&&notFound;)"circlezero"==allObjects[j].type&&allObjects[j].belongsTo==r[i]&&(n.push(r[i]),t.addWithUpdate(allObjects[j]),notFound=!1,console.log("Found circlezero for circleone",n)),j+=1;if(-1==$.inArray(r[i],a))for(j=0,notFound=!0;j<allObjects.length&&notFound;)"customline"==allObjects[j].type&&allObjects[j].objId==r[i]&&(a.push(r[i]),t.addWithUpdate(allObjects[j]),notFound=!1,console.log("Found customline for circleone",a)),j+=1}for(i=0;i<a.length;i++){if(-1==$.inArray(a[i],n))for(j=0,notFound=!0;j<allObjects.length&&notFound;)"circlezero"==allObjects[j].type&&allObjects[j].belongsTo==a[i]&&(n.push(a[i]),t.addWithUpdate(allObjects[j]),notFound=!1,console.log("Found circlezero for customline",n)),j+=1;if(-1==$.inArray(a[i],r))for(j=0,notFound=!0;j<allObjects.length&&notFound;)"circleone"==allObjects[j].type&&allObjects[j].belongsTo==a[i]&&(r.push(a[i]),t.addWithUpdate(allObjects[j]),notFound=!1,console.log("Found circleone for customline",r)),j+=1}console.log("circleOneInCollection:",r),console.log("circleZeroInCollection:",n),console.log("customLineInCollection:",a),canvas.renderAll()}log.info("Leaving objectSelected")}function mouseOut(e){log.info("Entering mouseOut"),contextmenuon=!0,log.trace("Viewing target in mouseOut"),log.trace(e.target),log.debug("Rendering All"),canvas.renderAll(),log.debug("Done Rendering All"),log.info("Leaving mouseOut")}function mouseOver(e){log.info("Entering mouseOver"),contextmenuon=!1,activeObjectVal=e.target,e.target.type&&"line"==e.target.type&&(log.debug("Target is line"),searchId=getItemIndex(e.target),log.trace(e.target),canvas.setActiveObject(canvas.item(searchId))),log.info("Leaving mouseOver")}function postProcessLoading(e,o){log.info("Entering postProcessLoading"),"custom-image"==o.type&&(log.debug("Processing custom-image"),o.on("mousedown",function(e,o){imageDown(e,o)})),"circle"==o.type&&(log.debug("Processing circle"),o.fill=void 0,o.on("mousedown",function(e,o){circleDown(e,o)})),"circleone"==o.type&&(log.debug("Processing circleone"),o.hasBorders=o.hasControls=!1),"circlezero"==o.type&&(log.debug("Processing circleone"),o.hasBorders=o.hasControls=!1),"ellipse"==o.type&&(log.debug("Processing ellipse"),o.fill=void 0,o.on("mousedown",function(e,o){ellipseDown(e,o)})),"rect"==o.type&&(log.debug("Processing rect"),o.fill=void 0,o.on("mousedown",function(e,o){rectangleDown(e,o)})),"customline"==o.type&&(log.debug("Processing customline"),o.hasControls=!1,o.on("mousedown",function(e,o){lineDown(e,o)})),"i-text"==o.type&&(log.debug("Processing i-text"),o.on("mousedown",function(e,o){textDown(e,o)})),log.info("Leaving postProcessLoading")}function checkBackgroundFileExists(e){log.info("Entering checkBackgroundFileExists"),log.debug(e),$.ajax({url:e,type:"HEAD",error:function(){return log.debug("In Error Function checkBackgroundFileExists"),log.debug("Background File Not Found"),!1},success:function(){return log.debug("In success Function checkBackgroundFileExists"),log.debug("Background File Exists"),!0}}),log.info("Leaving checkBackgroundFileExists")}function loadCanvasDrawing(e){""!=e&&(log.debug("data_drawing not blank"),canvas.loadFromJSON(e,function(){canvas.renderAll.bind(canvas);var e=canvas.getObjects().map(function(e){return e.set("active",!1)});log.debug("Entering loop for objects"),log.debug("Loop size: ",e.length);var o=0,t=0;for(i=0;i<e.length;i++)log.debug("Objs Type: ",e[i].type),e[i].id=t,"customline"==e[i].type&&(e[i].hasControls=!1,console.log("customline: ",e[i]),console.log("Item Id of line set to: ",e[i].getObjId()),canvas.forEachObject(function(n){log.debug("Object Type: ",n.type),"circlezero"!=n.type&&"circleone"!=n.type||(log.debug("circleProspect.belongsTo: ",n.belongsTo),log.debug("objs[1].objId: ",e[i].objId)),"circlezero"==n.type&&n.belongsTo==e[i].objId&&(n.hasBorders=n.hasControls=!1,n.line=e[i],n.belongsTo=t,e[i].cone=n,n.set("hoverCursor","crosshair"),console.log("found circlezero"),o+=1),"circleone"==n.type&&n.belongsTo==e[i].objId&&(n.hasBorders=n.hasControls=!1,n.line=e[i],n.belongsTo=t,e[i].ctwo=n,n.set("hoverCursor","crosshair"),console.log("found circleone"),o+=1),2==o&&(console.log("objId: ",e[i].get("objId")),e[i].setObjId(t),t+=1,e[i].cone.id=t,t+=1,e[i].ctwo.id=t,o=0)}),e[i].on("mousedown",function(e,o){lineDown(e,o)})),"customlinearrow"==e[i].type&&(e[i].hasControls=!1,console.log("customline: ",e[i]),console.log("Item Id of line set to: ",e[i].getObjId()),canvas.forEachObject(function(n){log.debug("Object Type: ",n.type),"carrow"!=n.type&&"conearrow"!=n.type||(log.debug("circleProspect.belongsTo: ",n.belongsTo),log.debug("objs[1].objId: ",e[i].objId)),"conearrow"==n.type&&n.belongsTo==e[i].objId&&(n.hasBorders=n.hasControls=!1,n.line=e[i],n.belongsTo=t,e[i].conearrow=n,n.set("hoverCursor","crosshair"),console.log("found conearrow"),o+=1),"carrow"==n.type&&n.belongsTo==e[i].objId&&(n.hasBorders=n.hasControls=!1,n.line=e[i],n.belongsTo=t,e[i].carrow=n,n.set("hoverCursor","crosshair"),console.log("found carrow"),o+=1),2==o&&(console.log("objId: ",e[i].get("objId")),e[i].setObjId(t),t+=1,e[i].conearrow.id=t,t+=1,e[i].carrow.id=t,o=0)}),e[i].on("mousedown",function(e,o){lineArrowDown(e,o)})),"customlinetwoarrow"==e[i].type&&(e[i].hasControls=!1,console.log("customline: ",e[i]),console.log("Item Id of line set to: ",e[i].getObjId()),canvas.forEachObject(function(n){log.debug("Object Type: ",n.type),"carrow"!=n.type&&"carrowtwo"!=n.type||(log.debug("circleProspect.belongsTo: ",n.belongsTo),log.debug("objs[1].objId: ",e[i].objId)),"carrowtwo"==n.type&&n.belongsTo==e[i].objId&&(n.hasBorders=n.hasControls=!1,n.line=e[i],n.belongsTo=t,e[i].carrowtwo=n,n.set("hoverCursor","crosshair"),console.log("found carrowtwo"),o+=1),"carrow"==n.type&&n.belongsTo==e[i].objId&&(n.hasBorders=n.hasControls=!1,n.line=e[i],n.belongsTo=t,e[i].carrow=n,n.set("hoverCursor","crosshair"),console.log("found carrow"),o+=1),2==o&&(console.log("objId: ",e[i].get("objId")),e[i].setObjId(t),t+=1,e[i].carrowtwo.id=t,t+=1,e[i].carrow.id=t,o=0)}),e[i].on("mousedown",function(e,o){lineArrowDown(e,o)})),t+=1;canvas.renderAll(),backgroundImageVal="",canvas.hasOwnProperty("backgroundImage")&&canvas.backgroundImage.hasOwnProperty("src")&&(backgroundImageVal=canvas.backgroundImage.src),log.debug("BackgroundImage Loc: ",backgroundImageVal),backgroundExists(backgroundImageVal)},postProcessLoading))}function loadVersionsIntoPanel(e){versions=JSON.parse(e),$("tbody#versionslisttab tr").remove();for(var o=versions.length,t=0;o>t;t++){vararray=JSON.parse(versions[t]),log.debug("Timestamp: ",vararray[0],":",vararray[1]);var n="/companies/"+company_id+"/users/"+user_id+"/drawings/"+drawing_id+"/changeversion?version="+vararray[0];tr='<tr> <td> <a href="#" onclick="loadversion(\''+n+"'); return false;\">"+vararray[1]+"</a></td> </tr>",$("#versionslisttab").append(tr)}}function resetFormElement(e){e.wrap("<form>").closest("form").get(0).reset(),e.unwrap(),e.stopPropagation(),e.preventDefault()}function loadversion(e){$(".spinner").show(),e=e+"&modified="+modified,$.ajax({url:e,data:{format:"json"},error:function(e){console.log(e),console.log("An error has occurred"),$(".spinner").fadeOut(400)},success:function(e){log.trace("Data from AJAX: ",e),log.trace("Last Edit: ",JSON.parse(e[0])),loadVersionsIntoPanel(e[1]),loadCanvasDrawing(e[2]),modified=!1,$(".spinner").fadeOut(400)},type:"GET"})}function handleDragStart(){log.info("Entering handleDragStart"),[].forEach.call(images,function(e){e.classList.remove("img_dragging")}),this.classList.add("img_dragging"),log.info("Leaving handleDragStart")}function makeLine(e,o){return log.info("Entering makeLine"),log.debug("Coords are: ",e),line=new fabric.Customline(e,{x1:e[0],y1:e[1],x2:e[2],y2:e[3],fill:"red",stroke:"red",strokeWidth:5,selectable:!0,objId:o,perPixelTargetFind:!0}),line.hasControls=!1,log.info("Leaving makeLine"),line}function makeLineArrow(e,o){return log.info("Entering makeLine"),log.debug("Coords are: ",e),line=new fabric.Customlinearrow(e,{x1:e[0],y1:e[1],x2:e[2],y2:e[3],fill:"red",stroke:"red",strokeWidth:5,selectable:!0,objId:o,perPixelTargetFind:!0}),line.hasControls=!1,log.info("Leaving makeLine"),line}function makeLineTwoArrow(e,o){return log.info("Entering makeLine"),log.debug("Coords are: ",e),line=new fabric.Customlinetwoarrow(e,{x1:e[0],y1:e[1],x2:e[2],y2:e[3],fill:"red",stroke:"red",strokeWidth:5,selectable:!0,objId:o,perPixelTargetFind:!0}),line.hasControls=!1,log.info("Leaving makeLine"),line}function makeArrowShape(e){return arrow=new fabric.Arrowone({left:line.get(e[0]),top:line.get(e[1]),originX:"center",originY:"center",hasBorders:!1,hasControls:!1,lockScalingX:!0,lockScalingY:!0,lockRotation:!0,pointType:"arrow_start",angle:-225,width:20,height:20,fill:"#000"}),arrow}function makeCircleShape(e){return log.info("Entering makeCircleShape"),new fabric.Circle({top:e[1],left:e[0],radius:15,fill:void 0,stroke:"red",lockUniScaling:!0,hasRotatingPoint:!1,strokeWidth:5})}function makeEllipseShape(e){return log.info("Entering makeEllipseShape"),new fabric.Ellipse({top:e[1],left:e[0],rx:15,ry:7,fill:void 0,stroke:"red",lockUniScaling:!1,hasRotatingPoint:!0,strokeWidth:5})}function makeRectangleShape(e){return log.info("Entering makeRectangleShape"),new fabric.Rect({top:e[1],left:e[0],width:67,height:45,fill:void 0,stroke:"red",hasRotatingPoint:!0,strokeWidth:5})}function activateColorPicker(e){log.info("Entering activateColorPicker"),console.log("activateColorPicker: ",e),activeObjectValCP=activeObjectVal,document.getElementById("myColor").color.showPicker(),log.info("Leaving activateColorPicker")}function colorPickerChange(e){log.info("Entering colorPickerChange"),log.debug("newLineColor: ",e),activeObjectValCP&&(log.trace("activeObjectVal: ",activeObjectValCP),activeObjectValCP.type&&(log.trace("activeObjectVal.type: ",activeObjectValCP.type),"customline"==activeObjectValCP.type&&(log.debug("colorPickerChange on line type"),activeObjectValCP.fill=e,activeObjectValCP.stroke=e),"customlinearrow"==activeObjectValCP.type&&(log.debug("colorPickerChange on line type"),activeObjectValCP.fill=e,activeObjectValCP.stroke=e),"customlinetwoarrow"==activeObjectValCP.type&&(log.debug("colorPickerChange on line type"),activeObjectValCP.fill=e,activeObjectValCP.stroke=e),"circle"==activeObjectValCP.type&&(log.debug("colorPickerChange on circle type"),activeObjectValCP.stroke=e),"ellipse"==activeObjectValCP.type&&(log.debug("colorPickerChange on ellipse type"),activeObjectValCP.stroke=e),"rect"==activeObjectValCP.type&&(log.debug("colorPickerChange on rect type"),activeObjectValCP.stroke=e),"i-text"==activeObjectValCP.type&&(log.debug("colorPickerChange on i-text type"),activeObjectValCP.stroke=e))),canvas.renderAll(),log.info("Leaving colorPickerChange")}function makeCircle(e){log.info("Entering makeCircle");var o=new fabric.Circlezero({left:e.get("x1")-2.5,top:e.get("y1")-2.5,visible:"true",hoverCursor:"crosshair",strokeWidth:2,stroke:"#000",radius:5,fill:"#fff"});o.setBelongsTo(e.objId);var t=new fabric.Circleone({left:e.get("x2")-2.5,top:e.get("y2")-2.5,visible:"true",hoverCursor:"crosshair",strokeWidth:2,stroke:"#000",radius:5,fill:"#fff"});t.setBelongsTo(e.objId),o.hasBorders=o.hasControls=!1,t.hasBorders=t.hasControls=!1,o.line=e,t.line=e,e.cone=o,e.ctwo=t;var n=new Array(o,t);return log.info("Leaving makeCircle"),n}function makeCircleArrow(e){log.info("Entering makeCircleArrow");var o=new fabric.Conearrow({left:e.get("x1")-2.5,top:e.get("y1")-2.5,visible:"true",hoverCursor:"crosshair",strokeWidth:2,stroke:"#000",radius:5,fill:"#fff"});o.setBelongsTo(e.objId);var t=new fabric.Carrow({left:e.get("x2"),top:e.get("y2"),originX:"center",originY:"center",hasBorders:!1,hasControls:!1,lockScalingX:!0,lockScalingY:!0,lockRotation:!0,pointType:"arrow_start",angle:135,width:20,height:20,fill:"#000"});t.setBelongsTo(e.objId),o.hasBorders=o.hasControls=!1,t.hasBorders=t.hasControls=!1,o.line=e,t.line=e,e.conearrow=o,e.carrow=t;var n=new Array(o,t);return log.info("Leaving makeCircle"),n}function makeArrowTwo(e){log.info("Entering makeArrowTwo");var o=new fabric.Carrowtwo({left:e.get("x1")-2.5,top:e.get("y1")-2.5,originX:"center",originY:"center",hasBorders:!1,hasControls:!1,lockScalingX:!0,lockScalingY:!0,lockRotation:!0,pointType:"arrow_start",angle:-45,width:20,height:20,fill:"#000"});o.setBelongsTo(e.objId);var t=new fabric.Carrow({left:e.get("x2"),top:e.get("y2"),originX:"center",originY:"center",hasBorders:!1,hasControls:!1,lockScalingX:!0,lockScalingY:!0,lockRotation:!0,pointType:"arrow_start",angle:135,width:20,height:20,fill:"#000"});t.setBelongsTo(e.objId),o.hasBorders=o.hasControls=!1,t.hasBorders=t.hasControls=!1,o.line=e,t.line=e,e.carrowtwo=o,e.carrow=t;var n=new Array(o,t);return log.info("Leaving makeCircle"),n}function handleDragOver(e){return log.info("Entering handleDragOver"),e.preventDefault&&e.preventDefault(),e.dataTransfer.dropEffect="copy",log.info("Leaving handleDragOver"),!1}function handleDragEnter(){log.info("Entering handleDragEnter"),this.classList.add("over"),log.info("Leaving handleDragEnter")}function handleDragLeave(){log.info("Entering handleDragLeave"),this.classList.remove("over"),log.info("Leaving handleDragLeave")}function sendBackward(){log.info("Entering sendBackward");var e=canvas.getActiveObject();e&&canvas.sendBackwards(e),$("#contextMenu").remove(),contextmenuon=!1,activeObject=!1,log.info("Leaving sendBackward")}function sendToBack(){log.info("Entering sendToBack");var e=canvas.getActiveObject();e&&canvas.sendToBack(e),$("#contextMenu").remove(),contextmenuon=!1,activeObject=!1,log.info("Leaving sendToBack")}function bringFoward(){log.info("Entering bringFoward");var e=canvas.getActiveObject();e&&canvas.bringForward(e),$("#contextMenu").remove(),contextmenuon=!1,activeObject=!1,log.info("Leaving bringFoward")}function bringToFront(){log.info("Entering bringToFront");var e=canvas.getActiveObject();e&&canvas.bringToFront(e),$("#contextMenu").remove(),contextmenuon=!1,activeObject=!1,log.info("Leaving bringToFront")}function lineDown(e){log.info("Entering lineDown"),console.log("Entering lineDown"),console.log("data: ",e),activeObjectVal&&(activeObject=!0),""!=handler&&document.removeEventListener("contextmenu",handler),3==e.e.which&&(handler=function(e){if(0==contextmenuon&&1==activeObject){e.preventDefault();var o=["Delete Line","Change Color","Send Backward","Send To Back","Bring Forward","Bring To Front"];menus(o,e),$('a:contains("Delete")').click(function(){if(activeObjectVal.type)if("customline"==activeObjectVal.type)canvas.remove(activeObjectVal.cone),canvas.remove(activeObjectVal.ctwo),canvas.remove(activeObjectVal);else if(activeObjectVal.hasOwnProperty("belongsTo")){console.log("removing belongTo object");for(var e=canvas.getObjects(),o=activeObjectVal.get("belongsTo"),t=!1,n=0;!t&&n<e.length;)"customline"==e[n].type&&e[n].objId==o&&(t=!0),n+=1;t&&(n-=1,canvas.remove(e[n].cone),canvas.remove(e[n].ctwo),canvas.remove(e[n])),canvas.renderAll()}$("#contextMenu").remove(),contextmenuon=!1,activeObject=!1}),$('a:contains("Change Color")').click(function(){activateColorPicker(e),$("#contextMenu").remove(),contextmenuon=!1}),$('a:contains("Send Backward")').click(function(){sendBackward()}),$('a:contains("Send To Back")').click(function(){sendToBack()}),$('a:contains("Bring Forward")').click(function(){bringFoward()}),$('a:contains("Bring To Front")').click(function(){bringToFront()}),contextmenuon=!0}},document.addEventListener("contextmenu",handler,!1)),log.info("Leaving lineDown")}function lineArrowDown(e){log.info("Entering lineDown"),console.log("Entering lineDown"),console.log("data: ",e),activeObjectVal&&(activeObject=!0),""!=handler&&document.removeEventListener("contextmenu",handler),3==e.e.which&&(handler=function(e){if(0==contextmenuon&&1==activeObject){e.preventDefault();var o=["Delete Line","Change Color","Send Backward","Send To Back","Bring Forward","Bring To Front"];menus(o,e),$('a:contains("Delete")').click(function(){if(activeObjectVal.type)if("customlinearrow"==activeObjectVal.type)canvas.remove(activeObjectVal.conearrow),canvas.remove(activeObjectVal.carrow),canvas.remove(activeObjectVal);else if(activeObjectVal.hasOwnProperty("belongsTo")){console.log("removing belongTo object");for(var e=canvas.getObjects(),o=activeObjectVal.get("belongsTo"),t=!1,n=0;!t&&n<e.length;)"customlinearrow"==e[n].type&&e[n].objId==o&&(t=!0),n+=1;t&&(n-=1,canvas.remove(e[n].conearrow),canvas.remove(e[n].carrow),canvas.remove(e[n])),canvas.renderAll()}$("#contextMenu").remove(),contextmenuon=!1,activeObject=!1}),$('a:contains("Change Color")').click(function(){activateColorPicker(e),$("#contextMenu").remove(),contextmenuon=!1}),$('a:contains("Send Backward")').click(function(){sendBackward()}),$('a:contains("Send To Back")').click(function(){sendToBack()}),$('a:contains("Bring Forward")').click(function(){bringFoward()}),$('a:contains("Bring To Front")').click(function(){bringToFront()}),contextmenuon=!0}},document.addEventListener("contextmenu",handler,!1)),log.info("Leaving lineDown")}function lineArrowTwoDown(e){log.info("Entering lineDown"),console.log("Entering lineDown"),console.log("data: ",e),activeObjectVal&&(activeObject=!0),""!=handler&&document.removeEventListener("contextmenu",handler),3==e.e.which&&(handler=function(e){if(0==contextmenuon&&1==activeObject){e.preventDefault();var o=["Delete Line","Change Color","Send Backward","Send To Back","Bring Forward","Bring To Front"];menus(o,e),$('a:contains("Delete")').click(function(){if(activeObjectVal.type)if("customlinetwoarrow"==activeObjectVal.type)canvas.remove(activeObjectVal.carrowtwo),canvas.remove(activeObjectVal.carrow),canvas.remove(activeObjectVal);else if(activeObjectVal.hasOwnProperty("belongsTo")){console.log("removing belongTo object");for(var e=canvas.getObjects(),o=activeObjectVal.get("belongsTo"),t=!1,n=0;!t&&n<e.length;)"customlinetwoarrow"==e[n].type&&e[n].objId==o&&(t=!0),n+=1;t&&(n-=1,canvas.remove(e[n].carrowtwo),canvas.remove(e[n].carrow),
canvas.remove(e[n])),canvas.renderAll()}$("#contextMenu").remove(),contextmenuon=!1,activeObject=!1}),$('a:contains("Change Color")').click(function(){activateColorPicker(e),$("#contextMenu").remove(),contextmenuon=!1}),$('a:contains("Send Backward")').click(function(){sendBackward()}),$('a:contains("Send To Back")').click(function(){sendToBack()}),$('a:contains("Bring Forward")').click(function(){bringFoward()}),$('a:contains("Bring To Front")').click(function(){bringToFront()}),contextmenuon=!0}},document.addEventListener("contextmenu",handler,!1)),log.info("Leaving lineDown")}function ellipseDown(e){log.info("Entering ellipseDown"),""!=handler&&document.removeEventListener("contextmenu",handler),activeObjectVal&&(activeObject=!0),3==e.e.which&&(handler=function(e){if(0==contextmenuon&&1==activeObject){e.preventDefault();var o=["Delete Ellipse","Change Color","Send Backward","Send To Back","Bring Forward","Bring To Front"];menus(o,e),$('a:contains("Delete")').click(function(){log.debug("ellipseDown: In Delete"),activeObjectVal=canvas.getActiveObject(),log.trace(activeObjectVal),canvas.remove(activeObjectVal),$("#contextMenu").remove(),contextmenuon=!1,activeObject=!1}),$('a:contains("Change Color")').click(function(){activateColorPicker(e),$("#contextMenu").remove(),contextmenuon=!1,activeObject=!1}),$('a:contains("Send Backward")').click(function(){sendBackward()}),$('a:contains("Send To Back")').click(function(){sendToBack()}),$('a:contains("Bring Forward")').click(function(){bringFoward()}),$('a:contains("Bring To Front")').click(function(){bringToFront()}),contextmenuon=!0}},document.addEventListener("contextmenu",handler,!1)),log.info("Leaving ellipseDown")}function circleDown(e){console.log("Data: ",e),log.info("Entering circleDown"),""!=handler&&document.removeEventListener("contextmenu",handler),activeObjectVal&&(activeObject=!0),3==e.e.which&&(handler=function(e){if(0==contextmenuon&&1==activeObject){e.preventDefault();var o=["Delete Circle","Change Color","Send Backward","Send To Back","Bring Forward","Bring To Front"];menus(o,e),$('a:contains("Delete")').click(function(){log.debug("circleDown: In Delete"),activeObjectVal=canvas.getActiveObject(),log.trace(activeObjectVal),canvas.remove(activeObjectVal),$("#contextMenu").remove(),contextmenuon=!1,activeObject=!1}),$('a:contains("Change Color")').click(function(){activateColorPicker(e),$("#contextMenu").remove(),contextmenuon=!1,activeObject=!1}),$('a:contains("Send Backward")').click(function(){sendBackward()}),$('a:contains("Send To Back")').click(function(){sendToBack()}),$('a:contains("Bring Forward")').click(function(){bringFoward()}),$('a:contains("Bring To Front")').click(function(){bringToFront()}),contextmenuon=!0}},document.addEventListener("contextmenu",handler,!1)),log.info("Leaving circleDown")}function rectangleDown(e){log.info("Entering rectangleDown"),""!=handler&&document.removeEventListener("contextmenu",handler),activeObjectVal&&(activeObject=!0),3==e.e.which&&(handler=function(e){if(0==contextmenuon&&1==activeObject){e.preventDefault();var o=["Delete Rectangle","Change Color","Send Backward","Send To Back","Bring Forward","Bring To Front"];menus(o,e),$('a:contains("Delete")').click(function(){log.debug("rectangleDown: In Delete"),activeObjectVal=canvas.getActiveObject(),log.trace(activeObjectVal),canvas.remove(activeObjectVal),$("#contextMenu").remove(),contextmenuon=!1,activeObject=!1}),$('a:contains("Change Color")').click(function(){activateColorPicker(e),$("#contextMenu").remove(),contextmenuon=!1,activeObject=!1}),$('a:contains("Send Backward")').click(function(){sendBackward()}),$('a:contains("Send To Back")').click(function(){sendToBack()}),$('a:contains("Bring Forward")').click(function(){bringFoward()}),$('a:contains("Bring To Front")').click(function(){bringToFront()}),contextmenuon=!0}},document.addEventListener("contextmenu",handler,!1)),log.info("Leaving rectangleDown")}function textDown(e){log.info("Entering textDown"),""!=handler&&document.removeEventListener("contextmenu",handler),activeObjectVal&&(activeObject=!0),3==e.e.which&&(handler=function(e){if(0==contextmenuon&&1==activeObject){e.preventDefault();var o=["Delete Text","Change Color","Send Backward","Send To Back","Bring Forward","Bring To Front"];menus(o,e),$('a:contains("Delete")').click(function(){log.debug("textDown: In Delete"),activeObjectVal=canvas.getActiveObject(),log.trace(activeObjectVal),canvas.remove(activeObjectVal),$("#contextMenu").remove(),contextmenuon=!1,activeObject=!1}),$('a:contains("Change Color")').click(function(){activateColorPicker(e),$("#contextMenu").remove(),contextmenuon=!1,activeObject=!1}),$('a:contains("Send Backward")').click(function(){sendBackward()}),$('a:contains("Send To Back")').click(function(){sendToBack()}),$('a:contains("Bring Forward")').click(function(){bringFoward()}),$('a:contains("Bring To Front")').click(function(){bringToFront()}),contextmenuon=!0}}),document.addEventListener("contextmenu",handler,!1),log.info("Leaving textDown")}function imageDown(e){log.info("Entering imageDown"),console.log("data",e),""!=handler&&document.removeEventListener("contextmenu",handler),activeObjectVal&&(activeObject=!0),3==e.e.which&&(handler=function(e){if(0==contextmenuon&&1==activeObject){if(e.preventDefault(),log.trace("ActiveObjectVal: ",activeObjectVal),log.trace("Has configdbid property: ",activeObjectVal.hasOwnProperty("configdbid")),0!=activeObjectVal.configdbid)var o=["Configure","Delete Image","Send To Back","Send Backward","Bring Forward","Bring To Front"];else var o=["Delete Image","Send To Back","Send Backward","Bring Forward","Bring To Front"];menus(o,e),$('a:contains("Configure")').click(function(){var e=activeObjectVal.configdbid,o=1;searchId=getItemIndex(activeObjectVal),canvas.setActiveObject(canvas.item(searchId)),configuratorProduct2(e,o,searchId),$("#contextMenu").remove(),contextmenuon=!1,activeObject=!0}),$('a:contains("Delete")').click(function(){log.debug("imageDown: In Delete"),log.trace(activeObjectVal),canvas.remove(activeObjectVal),$("#contextMenu").remove(),contextmenuon=!1,activeObject=!1}),$('a:contains("Change Color")').click(function(){activateColorPicker(e)}),$('a:contains("Send Backward")').click(function(){sendBackward()}),$('a:contains("Send To Back")').click(function(){sendToBack()}),$('a:contains("Bring Forward")').click(function(){bringFoward()}),$('a:contains("Bring To Front")').click(function(){bringToFront()}),contextmenuon=!0}}),document.addEventListener("contextmenu",handler,!1),log.info("Leaving imageDown")}function handleDrop(e){log.info("Entering handleDrop"),$("#saveMessage").text("Changes Made, Save Pending...");var o=document.querySelector("#images img.img_dragging");o.height=o.height,o.width=o.width,log.trace("Draggable Stage:",o);if(e.stopPropagation&&e.stopPropagation(),null!=o){var t=o.getAttribute("img_val");if(log.debug("imgsrc_val: ",t),"line.png"==t){log.debug("In line.png section"),objectName="customline";var n=e.layerX,r=e.layerY,a=n+25,i=r+25;objId=s;var l=makeLine([n,r,a,i],s);l.hasControls=!1,itemId+=1,l.id=itemId,l.objId=itemId,canvas.add(l),c[s]=makeCircle(l),l.cone=c[s][0],l.ctwo=c[s][1],console.log("Line coords: ",l.get("x1"),l.get("y1"),l.get("x2"),l.get("y2")),canvas.add(c[s][0],c[s][1]),canvas.renderAll(),l.on("mousedown",function(e,o){lineDown(e,o)})}else if("line_arrow_icon.png"==t){log.debug("In line.png section"),objectName="customlinearrow";var n=e.layerX,r=e.layerY,a=n+25,i=r+25;objId=s;var l=makeLineArrow([n,r,a,i],s);l.hasControls=!1,itemId+=1,l.id=itemId,l.objId=itemId,canvas.add(l),c[s]=makeCircleArrow(l),l.conearrow=c[s][0],l.carrow=c[s][1],console.log("Line coords: ",l.get("x1"),l.get("y1"),l.get("x2"),l.get("y2")),console.log("circle and arrow: ",c[s][0],":",c[s][1]),canvas.add(c[s][0],c[s][1]),canvas.renderAll(),l.on("mousedown",function(e,o){lineArrowDown(e,o)})}else if("line_arrow_two_icon.png"==t){log.debug("In line.png section"),objectName="customlinetwoarrow";var n=e.layerX,r=e.layerY,a=n+25,i=r+25;objId=s;var l=makeLineTwoArrow([n,r,a,i],s);l.hasControls=!1,itemId+=1,l.id=itemId,l.objId=itemId,canvas.add(l),c[s]=makeArrowTwo(l),l.carrowtwo=c[s][0],l.carrow=c[s][1],console.log("Line coords: ",l.get("x1"),l.get("y1"),l.get("x2"),l.get("y2")),console.log("circle and arrow: ",c[s][0],":",c[s][1]),canvas.add(c[s][0],c[s][1]),canvas.renderAll(),l.on("mousedown",function(e,o){lineArrowTwoDown(e,o)})}else if("circle_icon.png"==t){log.debug("In circle_icon.png section"),objectName="circle";var n=e.layerX,r=e.layerY,s=objId_var+1;objId=s;var g=makeCircleShape([n,r],s);g.hasBorders=g.hasControls=!0,g.on("mousedown",function(e,o){circleDown(e,o)}),g.id=itemId,itemId+=1,canvas.add(g)}else if("ellipse_icon.png"==t){log.debug("In ellipse_icon.png section"),objectName="circle";var n=e.layerX,r=e.layerY,s=objId_var+1;objId=s;var d=makeEllipseShape([n,r],s);d.hasBorders=d.hasControls=!0,d.on("mousedown",function(e,o){ellipseDown(e,o)}),d.id=itemId,itemId+=1,canvas.add(d)}else if("rectangle-icon.png"==t){log.debug("In rectangle-icon.png section"),objectName="rectangle";var n=e.layerX,r=e.layerY,s=objId_var+1;objId=s;var u=makeRectangleShape([n,r],s);u.hasBorders=u.hasControls=!0,u.on("mousedown",function(e,o){rectangleDown(e,o)}),u.id=itemId,itemId+=1,canvas.add(u)}else if("textbox_icon.png"==t){log.debug("In textbox_icon.png section");var f=new fabric.IText("Tap and Type",{fontFamily:"arial black",fontSize:12,left:e.layerX,top:e.layerY});f.hasBorders=f.hasControls=!0,f.id=itemId,itemId+=1,canvas.add(f),f.on("mousedown",function(e,o){textDown(e,o)})}else{log.debug("In drag down else category");var b=new fabric.CustomImage(o,{width:o.width,height:o.height,left:e.layerX,top:e.layerY,config:"undefined",origloc:"undefined"});o.hasAttribute("data-config")?(log.debug("Has data-config"),b.configdbid=o.getAttribute("data-config"),log.debug("data-config: ",b.configdbid)):b.configdbid=!1,o.hasAttribute("data-model")?(log.debug("Has data-model"),b.model=o.getAttribute("data-model"),log.debug("data-model: ",b.model)):b.model=!1,o.hasAttribute("data-loc")?(log.debug("Has data-loc"),b.origloc=o.getAttribute("data-loc"),log.debug("data-loc: ",b.origloc)):b.origloc=!1,b.id=itemId,b.setSrc("/assets/"+b.origloc,function(e){log.debug("Object"),log.debug("In callback for setSrc function"),log.trace(e)},{height:o.height,width:o.width}),b.setCoords(),log.debug("--- newImage.src ------"),log.debug("src:",b.getSrc()),log.debug("Height",b.getHeight()),log.debug("Width",b.getWidth()),itemId+=1,b.on("mousedown",function(e,o){imageDown(e,o)}),canvas.add(b),canvas.renderAll()}return this.classList.remove("over"),onSave(),!1}onSave(),log.info("Leaving handleDrop")}function contextMenu(e){log.info("Entering contextMenu");var o=e.offsetX,t=e.offsetY;return $.each(canvas._objects,function(e,n){var r=n.width/2,a=n.height/2;return o>=n.left-r&&o<=n.left+r&&t>=n.top-a&&t<=n.top+a?!1:void 0}),log.info("Leaving contextMenu"),!1}function menus(e,o){log.info("Entering menus");var t="";if(0==contextmenuon){var n=document.createElement("div");n.id="contextMenu";var r="<ul class='dropdown-menu' role='menu' style='display:block;position:static;' >";for(index=0;index<e.length;index++)r+="<li> <a tabindex=''-1'>"+e[index]+"</a> </li>";r+="</ul>",n.innerHTML=r,$("body").append(n),t=$("#contextMenu"),t.css({display:"block",left:o.pageX,top:o.pageY})}else log.info("Menu Not Displayed contextmenu is true");log.info("Leaving menus")}function handleDragEnd(){log.info("Entering handleDragEnd"),[].forEach.call(images,function(e){e.classList.remove("img_dragging")}),log.info("Leaving handleDragEnd")}function drawAsPNG(){return log.info("Entering drawAsPNG"),canvas.isDrawingMode=!1,window.localStorage?(window.open(canvas.toDataURL("png")),void log.info("Leaving drawAsPNG")):void alert("This function is not supported by your browser.")}function getItemIndex(e){for(log.info("Entering getItemIndex"),id=e.id,index=0,objectList=canvas.getObjects(),i=0;i<objectList.length;i++)objectList[i].id==id&&(index=i);return log.info("Leaving getItemIndex"),index}function configuratorProduct(e,o,t){log.info("Entering configuratorProduct"),popup=window.open("/companies/"+o+"/prices/"+e+"/productconfig.html?searchId="+t,"Popup","width=300,height=500"),popup.focus(),log.info("Leaving configuratorProduct")}function backgroundModal(){log.info("Entering backgroundModal"),$("#backgroundSection").modal("show"),log.info("Leaving backgroundModal")}function loadConfigScreen(e,o,t){if(jsondata=e,log.info("Entering loadConfigScreen"),log.trace("jsondata: ",jsondata),"Data Not Found"==jsondata.error)document.getElementById("data").innerHTML+="<br>"+jsondata.error;else{jsondataprice=JSON.parse(jsondata.price);var n=document.createElement("div");n.className="form-group form-group-sm";var r=document.createElement("div");for(r.className="control-label col-sm-3",r.innerHTML+=jsondata.name,n.appendChild(r),document.getElementById("data").appendChild(n),i=0;i<jsondataprice.product.options.length;i++){var a=document.createElement("div");a.className="form-group form-group-sm";var c=document.createElement("label");c.className="control-label col-sm-3",c.innerHTML+=jsondataprice.product.options[i].opname,a.appendChild(c);var l=document.createElement("div");l.className="control-label col-sm-9";var s="",g="select"+i;for(s='<select class="form-control input-sm" id="'+g+'">',j=0;j<jsondataprice.product.options[i].selections.length;j++)s+='<option value=\'{"code":"',s+=jsondataprice.product.options[i].selections[j].code,s+='","price":"',s+=jsondataprice.product.options[i].selections[j].price,s+="\"}'",o&&jsondataprice.product.options[i].selections[j].code==t[i+1]&&(s+=' selected="selected" '),s+=">",s+=jsondataprice.product.options[i].selections[j].description,s+="</option>";s+="</select>",l.innerHTML+=s,a.appendChild(l),document.getElementById("data").appendChild(a)}var a=document.createElement("div");a.className="form-group form-group-sm";var c=document.createElement("label");c.className="control-label col-sm-3",c.innerHTML+="Configuration: ",a.appendChild(c);var d=document.createElement("div");d.className="col-sm-9 input-sm";var l=document.createElement("p");l.className="pull-left",l.id="prodconfig",d.appendChild(l),a.appendChild(d),document.getElementById("data").appendChild(a);var u=document.createElement("div");u.className="form-group form-group-sm";var c=document.createElement("label");c.className="control-label col-sm-3",c.innerHTML+="List Price: ",u.appendChild(c);var d=document.createElement("div");d.className="col-sm-9 input-sm";var l=document.createElement("p");for(l.className="pull-left",l.id="price",d.appendChild(l),u.appendChild(d),document.getElementById("data").appendChild(u),configString(jsondata,searchId),log.debug("Adding Listeners: Before For Loop"),i=0;i<jsondataprice.product.options.length;i++){var g="select"+i;document.getElementById(g).onchange=function(){var e=this.selectedIndex,o=this.children[e].innerHTML.trim();log.trace(o),configString(jsondata,searchId)}}}$("#gifspinner").fadeOut(400),log.info("Leaving loadConfigScreen")}function configuratorProduct2(e,o,t){log.info("Entering configuratorProduct2"),$("#configsection").modal("show"),$("#gifspinner").show(),document.getElementById("data").innerHTML="";var n=!1,r="",a=canvas.item(t).config;void 0!=a&&(log.info("Object Config is Defined: ",a),n=!0,r=a.split("-"));var c="/companies/"+o+"/prices/"+e+"/productconfig.json",i="";$.ajax({url:c,type:"GET",dataType:"json",data:i,contentType:"application/json",timeout:3e3,complete:function(){$("#gifspinner").fadeOut(400),log.info("Ajax Call is Complete")},success:function(e){log.trace("configuratorProduct2: In Ajax Success"),loadConfigScreen(e,n,r),log.trace(e),log.info("Ajax Call is Success")},error:function(e,o){log.trace(e),alert(o),log.info(o)}}),log.info("Leaving configuratorProduct2")}function configString(e,o){log.info("Entering configString"),log.trace("configString:jasontext",e),jsondataprice=JSON.parse(e.price),log.trace("configString:jsondataprice",jsondataprice);var t=jsondataprice.product.name,n=jsondataprice.product.basePrice;for(i=0;i<jsondataprice.product.options.length;i++){selectid="select"+i;var r=document.getElementById(selectid).selectedIndex;t+="-";var a=JSON.parse(document.getElementById(selectid).children[r].value);t+=a.code,n=parseInt(n)+parseInt(a.price)}document.getElementById("prodconfig").innerHTML=t,document.getElementById("price").innerHTML=n,SetConfig(o),log.info("Leaving configString")}function SetConfig(e){log.info("Entering SetConfig"),canvas.item(e).setConfig(document.getElementById("prodconfig").innerHTML),canvas.item(e).price=document.getElementById("price").innerHTML,canvas.renderAll(),log.info("Leaving SetConfig")}function runBackground(){$("#lefile").value="",$("#backgroundfile").val(""),progressBar.addClass("progress-success"),progressBar.text("0%"),progressBar.attr("value","0")}function removeBackground(){$("#saveMessage").text("Changes Made, Save Pending..."),$("#lefile").attr("value",""),$("#lefile").val(""),canvas.setBackgroundImage(0,canvas.renderAll.bind(canvas)),onSave()}function backgroundExists(e){log.info("In background exists"),log.debug(e);var o=!1;return void 0===e||""===e?(o=!1,log.debug("Using Background Button"),$("#backgroundButton").length&&log.debug("Found Background Button"),$("#backgroundButtonText").length&&log.debug("Found backgroundButtonText"),backgroundButton(!1)):(o=!0,log.debug("Using Remove Background Button"),$("#backgroundButton").length&&log.debug("Found Background Button"),$("#backgroundButtonText").length&&log.debug("Found backgroundButtonText"),backgroundButton(!0)),log.debug("Background Exists?"),log.debug(o),log.info("Leaving Background Exists"),o}function backgroundButton(e){e?($("#backgroundButton").attr("onclick","removeBackgroundRoutine(); return false;"),$("#backgroundButtonText").html("Remove Background")):($("#backgroundButton").attr("onclick","addBackgroundRoutine(); return false;"),$("#backgroundButtonText").html("Background"))}function removeBackgroundRoutine(){return removeBackground(),backgroundButton(!1),!1}function addBackgroundRoutine(){return runBackground(),backgroundModal(),!1}function toggle_versions_pane(){var e="slide",o={direction:"right"},t=500;$("#versionspanel").toggle(e,o,t)}function calcArrowAngle(e,o,t,n){var r,a,c=0;return r=t-e,a=n-o,c=0===r?0===a?0:a>0?Math.PI/2:3*Math.PI/2:0===a?r>0?0:Math.PI:0>r?Math.atan(a/r)+Math.PI:0>a?Math.atan(a/r)+2*Math.PI:Math.atan(a/r),180*c/Math.PI}var onSave=debounce(function(){log.info("Entering onSave"),modified=!0,$(".saveMessage").text("Save In Progress..."),objects=canvas.getObjects();var e=objects.length;log.debug("Number of objects to process: ",e),console.log("Number of objects to process: ",e),canvas.renderAll();var o=$('meta[name="csrf-token"]').attr("content");canvas.backgroundColor="";var t={company_id:company_id,user_id:user_id,id:drawing_id,authenticity_token:o,png:"",drawing:canvas};log.trace(t);var n="/companies/"+company_id+"/users/"+user_id+"/drawings/"+drawing_id+".json";$.ajax({url:n,type:"patch",dataType:"json",contentType:"application/json",data:JSON.stringify(t),timeout:3e3,complete:function(){},success:function(e){textMsg=JSON.parse(e[0]),console.log("Text Msg: ",textMsg),$("#saveMessage").text(textMsg[0]),loadVersionsIntoPanel(e[1])},error:function(e,o){msg="Error: "+o,$("#saveMessage").text(msg)}}),log.info("Leaving onSave")},3e3);$(function(){$(".directUpload").find("input:file").each(function(e,o){log.debug("URL directUpload"),log.debug(n);var t=$(o);log.debug("fileInput"),log.trace(t);var n=$(t.parents("form:first")),r=(n.data("url")+"/"+n.data("form-data").key,$("#submitButton"));progressBar.css("display","inline"),t.fileupload({add:function(e,o){var t=[],n=/^image\/(gif|jpe?g|png)$/i;o.originalFiles[0].type.length&&!n.test(o.originalFiles[0].type)&&t.push("Not an accepted file type"),o.originalFiles[0].size.length&&o.originalFiles[0].size>1e6&&t.push("Filesize is too big"),t.length>0?alert(t.join("\n")):o.submit()},fileInput:t,url:n.data("url"),type:"POST",autoUpload:!0,formData:n.data("form-data"),paramName:"file",dataType:"XML",replaceFileInput:!1,progressall:function(e,o){var t=parseInt(o.loaded/o.total*100,10);$("#progress").show(),progressBar.text(t+"%"),progressBar.attr("value",t),console.log("Progress: ",t)},start:function(){progressBar.addClass("progress-success"),log.trace(n)},done:function(e,o){$("#saveMessage").text("Changes Made, Save Pending..."),r.prop("disabled",!1),$("#upload_button").removeAttr("disabled");var a=$(o.jqXHR.responseXML).find("Key").text(),c="//"+n.data("host")+"/"+a;log.debug("done:key,url"),log.debug(a),log.debug(c);var i=$("<input />",{type:"hidden",name:t.attr("name"),value:c});n.append(i),imageURL="https:"+c,log.debug("imageURL"),log.debug(imageURL),canvas.setBackgroundImage(imageURL,canvas.renderAll.bind(canvas),{backgroundImageOpacity:.5,backgroundImageStretch:!1,scaleX:1,scaleY:1,top:center.top,left:center.left,originX:"center",originY:"center",crossOrigin:"anonymous"}),$("#progress").hide(),$("#backgroundSection").modal("hide"),backgroundButton(!0),onSave()},fail:function(){r.prop("disabled",!1),progressBar.removeClass("progress-success").addClass("progress-danger")}})})});var popup,Inspect={TYPE_FUNCTION:"function",methods:function(e){var o=e||self,t=[];for(prop in o)typeof o[prop]==Inspect.TYPE_FUNCTION&&typeof Inspect[prop]!=Inspect.TYPE_FUNCTION&&t.push(prop);return t},properties:function(e){var o=e||self,t=[];for(prop in o)typeof o[prop]!=Inspect.TYPE_FUNCTION&&typeof Inspect[prop]!=Inspect.TYPE_FUNCTION&&t.push(prop);return t}};